<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Decap CMS Admin Dashboard" />
  <meta name="robots" content="noindex, nofollow" />
  <title>Admin Dashboard â€” GNTT</title>

  <!-- Favicons -->
  <link rel="icon" href="https://i.ibb.co/wFXBHmNh/image.png" type="image/png" />

  <!-- Admin Styles -->
  <link rel="stylesheet" href="admin-styles.css" />

  <!-- Netlify Identity Widget -->
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js" type="text/javascript"></script>
</head>
<body>
  <!-- Loading Screen -->
  <div id="cms-loading" class="cms-loading">
    <div class="particles" id="particles"></div>

    <div class="loading-card">
      <img
        src="https://i.ibb.co/wFXBHmNh/image.png"
        alt="GNTT Logo"
        class="loading-logo"
        width="120"
        height="120"
      />
      <h1 class="loading-title">GNTT Admin</h1>
      <p class="loading-subtitle">Content Management System</p>

      <div class="spinner-3d"></div>

      <div class="loading-status" id="loadingStatus">Initializing...</div>
    </div>
  </div>

  <!-- Authentication Error (just a helper overlay, NOT the real auth gate) -->
  <div id="auth-error" class="auth-error">
    <div class="error-card">
      <div class="error-icon">ðŸ”’</div>
      <h1 class="error-title">Authentication Required</h1>
      <p class="error-message">
        Please sign in with Netlify Identity to access the admin dashboard.
      </p>
      <button class="auth-btn" onclick="openIdentityLogin()" type="button">
        Sign In
      </button>
    </div>
  </div>

  <!-- Success Toast -->
  <div id="success-toast" class="success-toast">
    <span class="success-icon">âœ“</span>
    <div class="success-content">
      <div class="success-title">Success!</div>
      <div class="success-message" id="success-text">Welcome back!</div>
    </div>
  </div>

  <!-- Decap CMS -->
  <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>

  <!-- Admin Scripts -->
  <script>
    (function() {
      'use strict';

      console.log('[ADMIN] ðŸš€ Initializing GNTT Admin Dashboard');

      const loadingScreen  = document.getElementById('cms-loading');
      const authError      = document.getElementById('auth-error');
      const loadingStatus  = document.getElementById('loadingStatus');
      const successToast   = document.getElementById('success-toast');
      const successText    = document.getElementById('success-text');

      let loginInProgress  = false;

      // Particles
      function createParticles() {
        const particles = document.getElementById('particles');
        if (!particles) return;
        for (let i = 0; i < 50; i++) {
          const particle = document.createElement('div');
          particle.className = 'particle';
          particle.style.left = Math.random() * 100 + '%';
          particle.style.animationDelay = Math.random() * 20 + 's';
          particle.style.animationDuration = (15 + Math.random() * 10) + 's';
          particles.appendChild(particle);
        }
      }
      createParticles();

      // Helpers
      function updateStatus(message) {
        if (loadingStatus) loadingStatus.textContent = message;
        console.log('[ADMIN]', message);
      }

      function hideLoading() {
        if (!loadingScreen) return;
        setTimeout(() => {
          loadingScreen.classList.add('hidden');
        }, 500);
      }

      function showAuthOverlay() {
        if (loadingScreen) loadingScreen.classList.add('hidden');
        if (authError) authError.classList.add('show');
      }

      function showSuccess(message, title) {
        if (!successToast || !successText) return;
        successText.textContent = message || 'Welcome back!';
        successToast.querySelector('.success-title').textContent = title || 'Success!';
        successToast.classList.add('show');
        setTimeout(() => {
          successToast.classList.remove('show');
        }, 4000);
      }

      // Central login opener
      function openIdentityLogin() {
        if (!window.netlifyIdentity) {
          console.error('[ADMIN] âŒ Netlify Identity not available when trying to open login');
          return;
        }

        // Allow the Identity modal to be on top
        if (authError) authError.classList.remove('show');
        if (loadingScreen) loadingScreen.classList.add('hidden');

        updateStatus('Opening Netlify Identity loginâ€¦');
        window.netlifyIdentity.open('login');
      }
      window.openIdentityLogin = openIdentityLogin;

      // Initialize Identity
      if (window.netlifyIdentity) {
        updateStatus('ðŸ” Checking authentication with Netlify Identityâ€¦');

        // Recommended explicit init
        window.netlifyIdentity.init();

        window.netlifyIdentity.on('init', (user) => {
          if (user) {
            const userName = user.user_metadata?.full_name || user.email;
            console.log('[ADMIN] âœ“ User already authenticated:', userName);
            updateStatus('Welcome, ' + userName + '!');
            hideLoading();
          } else {
            console.log('[ADMIN] âš ï¸ No user authenticated yet');
            updateStatus('Please sign in to continue');
            // Show overlay, but CMS will still render its own login if needed
            setTimeout(showAuthOverlay, 800);
          }
        });

        window.netlifyIdentity.on('login', (user) => {
          console.log('[ADMIN] âœ“ Identity login:', user && user.email);
          loginInProgress = true;
          const userName = (user && user.user_metadata && user.user_metadata.full_name) || 'Admin';
          showSuccess('Welcome back, ' + userName + '!', 'Login successful');

          if (authError) authError.classList.remove('show');
          hideLoading();

          setTimeout(() => {
            loginInProgress = false;
          }, 1500);
        });

        window.netlifyIdentity.on('logout', () => {
          console.log('[ADMIN] ðŸ‘‹ Identity logout');
          // Let Decap CMS react to logout; optionally go back to home
          window.location.href = '/';
        });

        window.netlifyIdentity.on('error', (err) => {
          console.error('[ADMIN] âŒ Netlify Identity error:', err);
          updateStatus('Authentication error occurred');
          showAuthOverlay();
          loginInProgress = false;
        });

        window.netlifyIdentity.on('close', () => {
          console.log('[ADMIN] â„¹ï¸ Identity modal closed');
          loginInProgress = false;
        });
      } else {
        console.error('[ADMIN] âŒ Netlify Identity script not loaded');
        updateStatus('Error: Netlify Identity unavailable');
        setTimeout(showAuthOverlay, 1000);
      }

      // Performance log
      window.addEventListener('load', () => {
        if (performance && performance.timing) {
          const t = performance.timing;
          const loadTime = t.loadEventEnd - t.navigationStart;
          console.log('[ADMIN] âš¡ Dashboard loaded in ' + loadTime + 'ms');
        }
      });

      // Unsaved changes guard (Decap CMS default selector)
      window.addEventListener('beforeunload', (e) => {
        const isDirty = document.querySelector('.nc-unsavedChanges-notification');
        if (isDirty) {
          e.preventDefault();
          e.returnValue = 'You have unsaved changes. Are you sure?';
          return e.returnValue;
        }
      });

      console.log('[ADMIN] âœ… Scripts loaded');
    })();
  </script>
</body>
</html>
