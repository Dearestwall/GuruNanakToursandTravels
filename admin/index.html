<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Decap CMS Admin Dashboard" />
  <meta name="robots" content="noindex, nofollow" />
  <title>Admin Dashboard â€” GNTT</title>
  
  <!-- Favicons -->
  <link rel="icon" href="https://i.ibb.co/wFXBHmNh/image.png" type="image/png" />
  
  <!-- Admin Styles -->
  <link rel="stylesheet" href="admin-styles.css" />
  
  <!-- Netlify Identity Widget -->
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
</head>
<body>
  <!-- Loading Screen -->
  <div id="cms-loading" class="cms-loading">
    <div class="particles" id="particles"></div>
    
    <div class="loading-card">
      <img 
        src="https://i.ibb.co/wFXBHmNh/image.png" 
        alt="GNTT Logo" 
        class="loading-logo"
        width="120"
        height="120"
      />
      <h1 class="loading-title">GNTT Admin</h1>
      <p class="loading-subtitle">Content Management System</p>
      
      <div class="spinner-3d"></div>
      
      <div class="loading-status" id="loadingStatus">Initializing...</div>
    </div>
  </div>

  <!-- Authentication Error -->
  <div id="auth-error" class="auth-error">
    <div class="error-card">
      <div class="error-icon">ðŸ”’</div>
      <h1 class="error-title">Authentication Required</h1>
      <p class="error-message">Please sign in to access the admin dashboard.</p>
      <button class="auth-btn" onclick="window.netlifyIdentity.open('login')" type="button">
        Sign In
      </button>
    </div>
  </div>

  <!-- Success Toast -->
  <div id="success-toast" class="success-toast">
    <span class="success-icon">âœ“</span>
    <div class="success-content">
      <div class="success-title">Success!</div>
      <div class="success-message" id="success-text">Welcome back!</div>
    </div>
  </div>

  <!-- Decap CMS -->
  <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>

  <!-- Admin Scripts -->
  <script>
    (function() {
      'use strict';

      console.log('[ADMIN] ðŸš€ Initializing GNTT Admin Dashboard');

      // DOM Elements
      const loadingScreen = document.getElementById('cms-loading');
      const authError = document.getElementById('auth-error');
      const loadingStatus = document.getElementById('loadingStatus');
      const successToast = document.getElementById('success-toast');
      const successText = document.getElementById('success-text');

      let isAuthenticated = false;
      let loginInProgress = false;

      // Create animated particles
      function createParticles() {
        const particles = document.getElementById('particles');
        for (let i = 0; i < 50; i++) {
          const particle = document.createElement('div');
          particle.className = 'particle';
          particle.style.left = Math.random() * 100 + '%';
          particle.style.animationDelay = Math.random() * 20 + 's';
          particle.style.animationDuration = (15 + Math.random() * 10) + 's';
          particles.appendChild(particle);
        }
      }

      createParticles();

      // Utility Functions
      function updateStatus(message) {
        loadingStatus.textContent = message;
        console.log('[ADMIN]', message);
      }

      function hideLoading() {
        setTimeout(() => {
          loadingScreen.classList.add('hidden');
        }, 1000);
      }

      function showAuthError() {
        loadingScreen.classList.add('hidden');
        authError.classList.add('show');
      }

      function showSuccess(message, title = 'Success!') {
        successText.textContent = message;
        successToast.querySelector('.success-title').textContent = title;
        successToast.classList.add('show');
        setTimeout(() => {
          successToast.classList.remove('show');
        }, 4000);
      }

      // Initialize Netlify Identity
      if (window.netlifyIdentity) {
        updateStatus('ðŸ” Checking authentication...');

        netlifyIdentity.on('init', user => {
          updateStatus('âœ“ Authentication check complete');

          if (!user) {
            console.log('[ADMIN] âš ï¸ No user authenticated');
            updateStatus('Please sign in to continue');
            
            setTimeout(() => {
              showAuthError();
              // Auto-open login after 1 second
              if (!loginInProgress) {
                setTimeout(() => {
                  netlifyIdentity.open('login');
                }, 1000);
              }
            }, 1500);

          } else {
            isAuthenticated = true;
            const userName = user.user_metadata?.full_name || user.email;
            console.log('[ADMIN] âœ“ User authenticated:', userName);
            updateStatus('Welcome, ' + userName + '!');
            hideLoading();
          }
        });

        // Login handler - NO AUTO-RELOAD
        netlifyIdentity.on('login', (user) => {
          console.log('[ADMIN] âœ“ User logged in:', user.email);
          loginInProgress = true;
          isAuthenticated = true;
          
          const userName = user.user_metadata?.full_name || 'Admin';
          showSuccess('Welcome back, ' + userName + '!', 'Login Successful');
          
          // Hide error, show loading
          authError.classList.remove('show');
          loadingScreen.classList.remove('hidden');
          updateStatus('Loading dashboard...');
          
          // Just hide the loading screen, don't reload
          setTimeout(() => {
            hideLoading();
            loginInProgress = false;
          }, 2000);
        });

        // Logout handler
        netlifyIdentity.on('logout', () => {
          console.log('[ADMIN] ðŸ‘‹ User logged out');
          isAuthenticated = false;
          localStorage.clear();
          sessionStorage.clear();
          window.location.href = '/';
        });

        // Error handler
        netlifyIdentity.on('error', err => {
          console.error('[ADMIN] âŒ Identity error:', err);
          updateStatus('Authentication error occurred');
          loginInProgress = false;
          showAuthError();
        });

        // Close handler
        netlifyIdentity.on('close', () => {
          loginInProgress = false;
          const currentUser = netlifyIdentity.currentUser();
          if (!currentUser && !isAuthenticated) {
            showAuthError();
          }
        });

      } else {
        console.error('[ADMIN] âŒ Netlify Identity not loaded');
        updateStatus('Error: Identity service unavailable');
        setTimeout(showAuthError, 2000);
      }

      // Performance Monitoring
      window.addEventListener('load', () => {
        if (performance && performance.timing) {
          const perfData = performance.timing;
          const loadTime = perfData.loadEventEnd - perfData.navigationStart;
          console.log(`[ADMIN] âš¡ Dashboard loaded in ${loadTime}ms`);
        }
      });

      // Network Status
      window.addEventListener('online', () => {
        console.log('[ADMIN] ðŸŒ Connection restored');
        showSuccess('Network connection restored', 'Online');
      });

      window.addEventListener('offline', () => {
        console.warn('[ADMIN] âš ï¸ Connection lost');
      });

      // Prevent accidental navigation with unsaved changes
      window.addEventListener('beforeunload', (e) => {
        const isDirty = document.querySelector('.nc-unsavedChanges-notification');
        if (isDirty) {
          e.preventDefault();
          e.returnValue = 'You have unsaved changes. Are you sure?';
          return e.returnValue;
        }
      });

      console.log('[ADMIN] âœ… Scripts loaded successfully');
    })();
  </script>
</body>
</html>
